{"version":3,"sources":["assets\\Script\\BaseFrame\\VoiceNative.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["var radix = 12;\nvar base = 128 - radix;\n\nfunction crypto(value) {\n    value -= base;\n    var h = Math.floor(value / radix) + base;\n    var l = value % radix + base;\n    return String.fromCharCode(h) + String.fromCharCode(l);\n}\n\nvar encodermap = {}\nvar decodermap = {}\nfor (var i = 0; i < 256; ++i) {\n    var code = null;\n    var v = i + 1;\n    if (v >= base) {\n        code = crypto(v);\n    } else {\n        code = String.fromCharCode(v);\n    }\n\n    encodermap[i] = code;\n    decodermap[code] = i;\n}\n\n// src_data => dst_data( 长度 + 数据)\nfunction encode(data) {\n    var content = \"\";\n    var len = data.length;\n\n    cc.log('encode, len=' + len + ', data=' + data);\n    var a = (len >> 24) & 0xff;\n    var b = (len >> 16) & 0xff;\n    var c = (len >> 8) & 0xff;\n    var d = len & 0xff;\n    content += encodermap[a];\n    content += encodermap[b];\n    content += encodermap[c];\n    content += encodermap[d];\n    for (var i = 0; i < data.length; ++i) {\n        content += encodermap[data[i]];\n    }\n    return content;\n}\n\nfunction getCode(content, index) {\n    var c = content.charCodeAt(index);\n    if (c >= base) {\n        c = content.charAt(index) + content.charAt(index + 1);\n    } else {\n        c = content.charAt(index);\n    }\n    return c;\n}\n\nfunction decode(content) {\n    var index = 0;\n    var len = 0;\n    for (var i = 0; i < 4; ++i) {\n        var c = getCode(content, index);\n        index += c.length;\n        var v = decodermap[c];\n        len |= v << (3 - i) * 8;\n    }\n\n    var newData = new Uint8Array(len);\n    var cnt = 0;\n    while (index < content.length) {\n        var c = getCode(content, index);\n        index += c.length;\n        newData[cnt] = decodermap[c];\n        cnt++;\n    }\n    return newData;\n}\n\nconst AndroidClassName = \"org/cocos2dx/javascript/VoiceRecorder\";\nconst IosClassName = \"VoiceSDK\";\n\n\nexport default new class VoiceNative {\n    private _voiceMediaPath: string = '';\n    public init() {\n        if (cc.sys.isNative) {\n            this._voiceMediaPath = jsb.fileUtils.getWritablePath() + \"/voicemsgs/\";\n            this.setStorageDir(this._voiceMediaPath);\n        }\n    }\n\n    public prepare(filename) {\n        if (!cc.sys.isNative) {\n            return;\n        }\n        //暂停现在正在播放的所有音频\n        cc.audioEngine.pauseAll();\n        // 删除之前\n        this.clearCache(filename);\n        if (cc.sys.isNative) {\n            if (cc.sys.os == cc.sys.OS_ANDROID) {\n                jsb.reflection.callStaticMethod(AndroidClassName, \"prepare\", \"(Ljava/lang/String;)V\", filename);\n            }\n            else if (cc.sys.os == cc.sys.OS_IOS) {\n                jsb.reflection.callStaticMethod(IosClassName, \"prepareRecord:\", filename);\n            }\n        }\n    }\n\n\n    public release() {\n        if (!cc.sys.isNative) {\n            return;\n        }\n        cc.audioEngine.resumeAll();\n        if (cc.sys.isNative) {\n            if (cc.sys.os == cc.sys.OS_ANDROID) {\n                jsb.reflection.callStaticMethod(AndroidClassName, \"release\", \"()V\");\n            }\n            else if (cc.sys.os == cc.sys.OS_IOS) {\n                // jsb.reflection.callStaticMethod(IosClassName, \"finishRecord\");\n            }\n        }\n    }\n\n    public cancel() {\n        if (!cc.sys.isNative) {\n            return;\n        }\n        cc.audioEngine.resumeAll();\n        if (cc.sys.isNative) {\n            if (cc.sys.os == cc.sys.OS_ANDROID) {\n                jsb.reflection.callStaticMethod(AndroidClassName, \"cancel\", \"()V\");\n            }\n            else if (cc.sys.os == cc.sys.OS_IOS) {\n                // jsb.reflection.callStaticMethod(IosClassName, \"cancelRecord\");\n            }\n        }\n    }\n\n    public writeVoice(filename, voiceData) {\n        if (!cc.sys.isNative) {\n            return;\n        }\n        if (voiceData && voiceData.length > 0) {\n            // var fileData = decode(voiceData);\n            var url = this._voiceMediaPath + filename;\n            this.clearCache(filename);\n            // @ts-ignore\n            jsb.fileUtils.writeDataToFile(voiceData, url);\n        }\n    }\n\n    public clearCache(filename) {\n        if (cc.sys.isNative) {\n            var url = this._voiceMediaPath + filename;\n            //console.log(\"check file:\" + url);\n            if (jsb.fileUtils.isFileExist(url)) {\n                //console.log(\"remove:\" + url);\n                jsb.fileUtils.removeFile(url);\n            }\n            if (jsb.fileUtils.isFileExist(url + \".wav\")) {\n                //console.log(\"remove:\" + url + \".wav\");\n                jsb.fileUtils.removeFile(url + \".wav\");\n            }\n        }\n    }\n\n    public play(filename) {\n        if (!cc.sys.isNative) {\n            return;\n        }\n        cc.audioEngine.pauseAll();\n        if (cc.sys.os == cc.sys.OS_ANDROID) {\n            jsb.reflection.callStaticMethod(\"org/cocos2dx/javascript/VoicePlayer\", \"play\", \"(Ljava/lang/String;)V\", filename);\n        }\n        else if (cc.sys.os == cc.sys.OS_IOS) {\n            jsb.reflection.callStaticMethod(IosClassName, \"play:\", filename);\n        }\n        else {\n        }\n    }\n\n    public getVoiceData(filename) {\n        if (cc.sys.isNative) {\n            var url = this._voiceMediaPath + filename;\n            console.log(\"getVoiceData:\" + url);\n            // 读取二进制文件 获取文件数据        \n            // @ts-ignore   \n            var fileData = jsb.fileUtils.getDataFromFile(url);\n\n            if (fileData) {\n                var content = fileData;\n                return content;\n            }\n        }\n        return \"\";\n    }\n\n    public getDataString(data) {\n        var content = encode(data);\n        return content;\n    }\n\n    public setStorageDir(dir:string) {\n        if (!cc.sys.isNative) {\n            return;\n        }\n        if (cc.sys.os == cc.sys.OS_ANDROID) {\n            jsb.reflection.callStaticMethod(AndroidClassName, \"setStorageDir\", \"(Ljava/lang/String;)V\", dir);\n        } else if (cc.sys.os == cc.sys.OS_IOS) {\n            jsb.reflection.callStaticMethod(IosClassName, \"setStorageDir:\", dir);\n            if (!jsb.fileUtils.isDirectoryExist(dir)) {\n                jsb.fileUtils.createDirectory(dir);\n            }\n        }\n    }\n\n\n}"]}