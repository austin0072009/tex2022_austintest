{"version":3,"sources":["assets\\GameHall\\script\\Lobby\\flowingwater\\MyInformationView.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;AAAA,0EAAyE;AACzE,oEAAmE;AACnE,kEAA6D;AAC7D,kFAAiF;AACjF,2DAAuE;AACvE,yDAAwD;AACxD,gDAAkK;AAClK,gDAA2C;AAE3C;;GAEG;AACH;IAA+C,qCAAQ;IAAvD;QAAA,qEAkKC;QAvJW,uBAAiB,GAAiB,IAAI,CAAC;QACvC,kBAAY,GAAe,IAAI,CAAC;QAChC,qBAAe,GAAoB,IAAI,CAAC;QACxC,mBAAa,GAAoB,IAAI,CAAC;QACtC,qBAAe,GAAoB,IAAI,CAAC;QACxC,kBAAY,GAAoB,IAAI,CAAC;QACrC,kBAAY,GAAoB,IAAI,CAAC;QACrC,uBAAiB,GAAiB,IAAI,CAAC;QAEvC,eAAS,GAAkB,EAAE,CAAC;QAC9B,aAAO,GAAW,CAAC,CAAC,CAAA,KAAK;QACzB,eAAS,GAAW,CAAC,CAAC,CAAA,KAAK;;IA4IvC,CAAC;IAjKG,sBAAc,kDAAmB;aAAjC;YACI,OAAO,UAAU,CAAC;QACtB,CAAC;;;OAAA;IACD,sBAAc,0CAAW;aAAzB;YACI,OAAO,WAAW,CAAC;QACvB,CAAC;;;OAAA;IACD,sBAAc,4CAAa;aAA3B;YACI,OAAO,aAAa,CAAC;QACzB,CAAC;;;OAAA;IAcD,iDAAqB,GAArB;QACI,iBAAM,qBAAqB,WAAE,CAAC;QAC9B,IAAI,CAAC,aAAa,CAAC,OAAO,GAAG,KAAK,CAAC;QACnC,IAAI,CAAC,iBAAiB,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;QAChD,IAAI,CAAC,YAAY,CAAC,YAAY,GAAG,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACrE,IAAI,CAAC,YAAY,CAAC,YAAY,GAAG,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IACpE,CAAC;IAED,2CAAe,GAAf;QACI,IAAI,CAAC,IAAI,EAAE,CAAC;IAChB,CAAC;IACD,gCAAI,GAAJ;QACI,2BAAY,CAAC,SAAS,CAAC,IAAI,CAAC,mBAAmB,EAAE,QAAQ,CAAC,CAAC;QAC3D,IAAI,IAAI,CAAC,eAAe,CAAC,OAAO,EAAE;YAC9B,IAAI,CAAC,YAAY,CAAC,OAAO,GAAG,IAAI,CAAC;YACjC,IAAI,CAAC,eAAe,CAAC,OAAO,GAAG,KAAK,CAAC;YACrC,IAAI,CAAC,iBAAiB,CAAC,OAAO,GAAG,KAAK,CAAC;YACvC,sBAAY,CAAC,QAAQ,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;SAC/C;aAAM;YACH,wCAAwC;YACxC,wDAAwD;YACxD,IAAI;YACJ,gDAAgD;YAChD,sBAAY,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,mBAAmB,EAAE,CAAC;YACxD,iBAAM,IAAI,WAAE,CAAC;SAChB;IACL,CAAC;IACM,gCAAI,GAAX;QACI,iBAAM,IAAI,WAAE,CAAC;QACb,IAAI,CAAC,SAAS,GAAG,CAAC,CAAC;QACnB,IAAI,CAAC,OAAO,GAAG,CAAC,CAAC;QACjB,IAAI,CAAC,YAAY,CAAC,oBAAoB,EAAE,CAAC;QACzC,IAAI,CAAC,SAAS,GAAG,sBAAY,CAAC,QAAQ,CAAC,KAAK,CAAC,SAAS,CAAC,SAAS,CAAC;QACjE,IAAI,CAAC,YAAY,CAAC,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,GAAG,CAAC,CAAC;IAC3D,CAAC;IAEM,+CAAmB,GAA1B,UAA2B,KAAa;QACpC,IAAI,KAAK,GAAG,CAAC,IAAI,CAAC,EAAE;YAChB,OAAO,uBAAuB,CAAC;SAClC;QACD,OAAO,sBAAsB,CAAC;IAClC,CAAC;IAEM,0CAAc,GAArB,UAAsB,KAAa,EAAE,IAAkB;QAAvD,iBAoCC;QAnCG,IAAI,EAAE,GAAiB,IAAI,CAAC;QAC5B,IAAI,KAAK,GAAG,CAAC,IAAI,CAAC,EAAE;YAChB,IAAI,UAAU,GAAG,IAAI,CAAC,SAAS,CAAC,eAAM,CAAC,WAAW,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC;YACrE,UAAU,GAAG,UAAU,IAAI,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,UAAU,CAAC;YAClD,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,WAAW,CAAC,IAAI,GAAG,UAAU,CAAC;SACnD;aAAM;YACH,EAAE,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC,WAAW,CAAC,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,eAAM,CAAC,WAAW,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC;YAChG,IAAI,SAAO,GAAG,IAAI,CAAC,SAAS,CAAC,eAAM,CAAC,WAAW,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC;YACpE,IAAI,MAAM,GAAG,SAAO,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;YACnC,SAAO,GAAG,EAAE,CAAC;YACb,MAAM,CAAC,OAAO,CAAC,UAAA,IAAI,IAAI,OAAA,SAAO,IAAI,IAAI,EAAf,CAAe,CAAC,CAAC;YACxC,eAAM,CAAC,WAAW,CAAC,EAAE,CAAC,QAAQ,CAAC,YAAY,CAAC,CAAC,WAAW,EAAE,SAAO,EAAE,EAAE,CAAC,CAAC;YACvE,EAAE,CAAC,QAAQ,CAAC,YAAY,CAAC,CAAC,WAAW,CAAC,IAAI,IAAI,KAAK,CAAC;YACpD,EAAE,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC,gBAAgB,CAAC,IAAI,CAAC,SAAS,CAAC,eAAM,CAAC,WAAW,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC;YACnG,IAAI,MAAM,GAAG,KAAK,CAAC;YACnB,oFAAoF;YACpF,qEAAqE;YACrE,IAAI;YACJ,QAAQ;YACR,IAAI,MAAM,GAAG,2BAAY,CAAC,QAAQ,CAAC,KAAK,CAAC,YAAY,CAAC,MAAM,CAAC;YAC7D,IAAI,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC,eAAM,CAAC,WAAW,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC;YACpE,IAAI,KAAK,GAAG,oBAAW,CAAC,MAAM,CAAC,QAAQ,GAAG,MAAM,GAAG,EAAE,GAAG,OAAO,EAAE,CAAC,CAAC,CAAC;YACpE,MAAM,GAAG,KAAK,IAAI,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,IAAI,CAAC;YACnC,IAAI,sBAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,CAAC,MAAM,EAAE;gBACvC,sBAAY,CAAC,QAAQ,CAAC,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC;gBAChD,IAAI,CAAC,SAAS,EAAE,CAAC;aACpB;YACD,IAAI;YACJ,EAAE,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC,gBAAgB,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;YAC1D,EAAE,CAAC,QAAQ,CAAC,YAAY,CAAC,CAAC,QAAQ,CAAC,UAAU,EAAE,CAAC;YAChD,EAAE,CAAC,QAAQ,CAAC,YAAY,CAAC,CAAC,QAAQ,CAAC,OAAO,CAAC;gBACvC,EAAE,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC;gBAC7C,KAAI,CAAC,eAAe,CAAC,KAAI,CAAC,SAAS,CAAC,eAAM,CAAC,WAAW,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;YACxE,CAAC,CAAC,CAAC;SACN;IACL,CAAC;IAEM,2CAAe,GAAtB,UAAuB,IAAiB;QAAxC,iBA6BC;QA5BG,OAAO,CAAC,GAAG,CAAC,iBAAiB,CAAC,CAAC;QAC/B,IAAI,CAAC,YAAY,CAAC,OAAO,GAAG,KAAK,CAAC;QAClC,IAAI,CAAC,eAAe,CAAC,OAAO,GAAG,IAAI,CAAC;QACpC,IAAI,CAAC,iBAAiB,CAAC,OAAO,GAAG,IAAI,CAAC;QACtC,IAAI,CAAC,aAAa,CAAC,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC;QACrC,IAAI,CAAC,eAAe,CAAC,IAAI,GAAG,IAAI,CAAC,OAAO,CAAC;QACzC,IAAI,CAAC,YAAY,CAAC,IAAI,GAAG,IAAI,GAAG,IAAI,CAAC,YAAY,CAAC;QAClD,IAAI,CAAC,YAAY,CAAC,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC;QAEpC,UAAU;QACV,0CAA0C;QAC1C,IAAI;QACJ,0CAA0C;QAC1C,oCAAoC;QACpC,oCAAoC;QACpC,qFAAqF;QACrF,SAAS;QACT,UAAU;QACV,IAAI,MAAM,GAAG,2BAAY,CAAC,QAAQ,CAAC,KAAK,CAAC,YAAY,CAAC,MAAM,CAAC;QAC7D,IAAI,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC;QAC3B,IAAI,oBAAW,CAAC,MAAM,CAAC,QAAQ,GAAG,MAAM,GAAG,EAAE,GAAG,OAAO,EAAE,CAAC,CAAC,IAAI,CAAC;YAAE,IAAI,CAAC,OAAO,EAAE,CAAC;QACjF,oBAAW,CAAC,MAAM,CAAC,QAAQ,GAAG,MAAM,GAAG,EAAE,GAAG,OAAO,EAAE,CAAC,CAAC,CAAC;QACxD,IAAI;QAEJ,IAAI,CAAC,iBAAiB,CAAC,UAAU,EAAE,CAAC;QACpC,IAAI,CAAC,iBAAiB,CAAC,OAAO,CAAC;YAC3B,KAAI,CAAC,cAAc,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;QACrD,CAAC,CAAC,CAAC;IACP,CAAC;IAEM,4CAAgB,GAAvB,UAAwB,IAAsB;QAC1C,IAAI,IAAI,CAAC,MAAM,IAAI,CAAC,EAAE;YAClB,OAAO,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;YACzB,OAAO;SACV;QACD,OAAO,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;IAC7B,CAAC;IAEM,0CAAc,GAArB,UAAsB,OAAe,EAAE,QAAgB;QACnD,IAAI,MAAM,GAAG,IAAI,6BAAc,EAAE,CAAC;QAClC,MAAM,CAAC,OAAO,GAAG,OAAO,CAAC;QACzB,MAAM,CAAC,QAAQ,GAAG,QAAQ,CAAC;QAC3B,MAAM,CAAC,EAAE,GAAG,gBAAgB,CAAC;QAC7B,mCAAgB,CAAC,WAAW,CAAC,QAAQ,CAAC,MAAM,EAAE,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;IAClF,CAAC;IAEM,0CAAc,GAArB,UAAsB,IAAoB;QACtC,6BAA6B;QAC7B,IAAI,IAAI,CAAC,MAAM,IAAI,CAAC,EAAE;YAClB,qBAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC;YAC9C,IAAI,CAAC,IAAI,EAAE,CAAC;SACf;aAAM,IAAI,IAAI,CAAC,MAAM,IAAI,CAAC,CAAC,EAAE;YAC1B,qBAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,CAAC;SAClD;aAAM,IAAI,IAAI,CAAC,MAAM,IAAI,CAAC,CAAC,EAAE;YAC1B,qBAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,YAAY,CAAC,kBAAkB,CAAC,CAAC;SAC5D;IACL,CAAC;IACL,wBAAC;AAAD,CAlKA,AAkKC,CAlK8C,kBAAQ,GAkKtD","file":"","sourceRoot":"/","sourcesContent":["import { AudioManager } from \"../../../../Script/BaseFrame/AudioManager\";\r\nimport { CommonCtr } from \"../../../../Script/BaseFrame/CommonCtr\";\r\nimport ViewBase from \"../../../../Script/BaseFrame/ViewBase\";\r\nimport { WebSocketManager } from \"../../../../Script/BaseFrame/WebSocketManager\";\r\nimport { PlayerPrefs, UIUtil } from \"../../../../Script/Common/UIUtil\";\r\nimport { LoginViewCtr } from \"../../Login/LoginViewCtr\";\r\nimport { cs_getemaillist, cs_removeEmail, cs_setemailstate, EmailinfoSD, MailTypeEnum, sc_getemaillist, sc_removeEmail, sc_setemailstate } from \"../LobbyNetData\";\r\nimport LobbyViewCtr from \"../LobbyViewCtr\";\r\n\r\n/**\r\n * @description 我的消息\r\n */\r\nexport default class MyInformationView extends ViewBase {\r\n    protected get packageResourceName(): string {\r\n        return \"gameHall\";\r\n    }\r\n    protected get packageName(): string {\r\n        return \"res/Lobby\";\r\n    }\r\n    protected get componentName(): string {\r\n        return \"information\";\r\n    }\r\n\r\n    private ui_btn_waterBreak: fgui.GButton = null;\r\n    private ui_EmailList: fgui.GList = null;\r\n    private ui_emailDetails: fgui.GComponent = null;\r\n    private ui_emailTitle: fgui.GTextField = null;\r\n    private ui_emailContent: fgui.GTextField = null;\r\n    private ui_emailFrom: fgui.GTextField = null;\r\n    private ui_emailTime: fgui.GTextField = null;\r\n    private ui_btnRemoveEmail: fgui.GButton = null;\r\n\r\n    private emaillist: EmailinfoSD[] = [];\r\n    private readCnt: number = 0;//已读数\r\n    private readCntUn: number = 0;//未读数\r\n    createChildComponents() {\r\n        super.createChildComponents();\r\n        this.fguiComponent.visible = false;\r\n        this.ui_btn_waterBreak.onClick(this.Hide, this);\r\n        this.ui_EmailList.itemProvider = this.getListItemResource.bind(this);\r\n        this.ui_EmailList.itemRenderer = this.renderListItem.bind(this);\r\n    }\r\n\r\n    OnLoadCompleted() {\r\n        this.Show();\r\n    }\r\n    Hide() {\r\n        AudioManager.Singleton.play('MyInformationView', \"button\");\r\n        if (this.ui_emailDetails.visible) {\r\n            this.ui_EmailList.visible = true;\r\n            this.ui_emailDetails.visible = false;\r\n            this.ui_btnRemoveEmail.visible = false;\r\n            LobbyViewCtr.instance.cs_getemaillist(true);\r\n        } else {\r\n            // if (this.readCnt == this.readCntUn) {\r\n            //     LobbyViewCtr.instance.view.setFlowingRead(false);\r\n            // }\r\n            // LobbyViewCtr.instance.cs_getemaillist(false);\r\n            LobbyViewCtr.instance.view.meView.refreshMessageEmail();\r\n            super.Hide();\r\n        }\r\n    }\r\n    public Show() {\r\n        super.Show();\r\n        this.readCntUn = 0;\r\n        this.readCnt = 0;\r\n        this.ui_EmailList.removeChildrenToPool();\r\n        this.emaillist = LobbyViewCtr.instance.Model.emailInfo.emaillist;\r\n        this.ui_EmailList.numItems = this.emaillist.length * 2;\r\n    }\r\n\r\n    public getListItemResource(index: number) {\r\n        if (index % 2 == 0) {\r\n            return \"ui://Lobby/zjTimeItem\";\r\n        }\r\n        return \"ui://Lobby/emailList\";\r\n    }\r\n\r\n    public renderListItem(index: number, item: fgui.GObject) {\r\n        let go = <fgui.GButton>item;\r\n        if (index % 2 == 0) {\r\n            let createTime = this.emaillist[UIUtil.NumberToInt(index / 2)]._time;\r\n            createTime = createTime == null ? \"\" : createTime;\r\n            go.getChild(\"n1\").asTextField.text = createTime;\r\n        } else {\r\n            go.getChild(\"emailName\").asTextField.text = this.emaillist[UIUtil.NumberToInt(index / 2)].title;\r\n            let content = this.emaillist[UIUtil.NumberToInt(index / 2)].content;\r\n            let conArr = content.split(\"\\r\\n\");\r\n            content = \"\";\r\n            conArr.forEach(item => content += item);\r\n            UIUtil.SetLimitTxt(go.getChild(\"emailIntro\").asTextField, content, 60);\r\n            go.getChild(\"emailIntro\").asTextField.text += \"...\";\r\n            go.getController(\"type\").setSelectedIndex(this.emaillist[UIUtil.NumberToInt(index / 2)]._type - 1);\r\n            let islook = false;\r\n            // if(this.emaillist[UIUtil.NumberToInt(index / 2)]._type == MailTypeEnum.personal){\r\n            //     islook = this.emaillist[UIUtil.NumberToInt(index / 2)].islook;\r\n            // }\r\n            // else{\r\n            let userid = LoginViewCtr.instance.Model.mPlayerModel.userid;\r\n            let tradeno = this.emaillist[UIUtil.NumberToInt(index / 2)].tradeno;\r\n            let lookN = PlayerPrefs.GetInt(\"ISLOOK\" + userid + \"\" + tradeno, 0);\r\n            islook = lookN == 0 ? false : true;\r\n            if (LobbyViewCtr.instance.view && !islook) {\r\n                LobbyViewCtr.instance.view.setFlowingRead(true);\r\n                this.readCntUn++;\r\n            }\r\n            // }\r\n            go.getController(\"read\").setSelectedIndex(islook ? 1 : 0);\r\n            go.getChild(\"buttonOpen\").asButton.clearClick();\r\n            go.getChild(\"buttonOpen\").asButton.onClick(() => {\r\n                go.getController(\"read\").setSelectedIndex(1);\r\n                this.ShowEmaiContent(this.emaillist[UIUtil.NumberToInt(index / 2)]);\r\n            });\r\n        }\r\n    }\r\n\r\n    public ShowEmaiContent(data: EmailinfoSD) {\r\n        console.log(\"ShowEmaiContent\");\r\n        this.ui_EmailList.visible = false;\r\n        this.ui_emailDetails.visible = true;\r\n        this.ui_btnRemoveEmail.visible = true;\r\n        this.ui_emailTitle.text = data.title;\r\n        this.ui_emailContent.text = data.content;\r\n        this.ui_emailFrom.text = \"——\" + data.fromUserName;\r\n        this.ui_emailTime.text = data._time;\r\n\r\n        //个人邮件标记已读\r\n        // if(data._type == MailTypeEnum.personal)\r\n        // {\r\n        //     let state = new cs_setemailstate();\r\n        //     state.tradeNo = data.tradeno;\r\n        //     state.fn =\"cs_setemailstate\";\r\n        //     WebSocketManager.getInstance.SendJSON(state,this.sc_setemailstate.bind(this));\r\n        // }else{\r\n        //其他邮件标记已读\r\n        let userid = LoginViewCtr.instance.Model.mPlayerModel.userid;\r\n        let tradeno = data.tradeno;\r\n        if (PlayerPrefs.GetInt(\"ISLOOK\" + userid + \"\" + tradeno, 0) == 0) this.readCnt++;\r\n        PlayerPrefs.SetInt(\"ISLOOK\" + userid + \"\" + tradeno, 1);\r\n        // }\r\n\r\n        this.ui_btnRemoveEmail.clearClick();\r\n        this.ui_btnRemoveEmail.onClick(() => {\r\n            this.cs_removeEmail(data.tradeno, data.ToUserId);\r\n        });\r\n    }\r\n\r\n    public sc_setemailstate(data: sc_setemailstate) {\r\n        if (data.result == 1) {\r\n            console.error(\"标记梯度成功！\");\r\n            return;\r\n        }\r\n        console.error(\"标记梯度失败！\");\r\n    }\r\n\r\n    public cs_removeEmail(tradeNo: string, toUserId: number) {\r\n        let remove = new cs_removeEmail();\r\n        remove.tradeNo = tradeNo;\r\n        remove.ToUserId = toUserId;\r\n        remove.fn = \"cs_removeEmail\";\r\n        WebSocketManager.getInstance.SendJSON(remove, this.sc_removeEmail.bind(this));\r\n    }\r\n\r\n    public sc_removeEmail(data: sc_removeEmail) {\r\n        //-1 邮件不存在  -2系统邮件不可删除。默认保留7天\r\n        if (data.result == 1) {\r\n            CommonCtr.instance.view.ShowTipLabel(\"刪除成功！\");\r\n            this.Hide();\r\n        } else if (data.result == -1) {\r\n            CommonCtr.instance.view.ShowTipLabel(\"郵件不存在！\");\r\n        } else if (data.result == -2) {\r\n            CommonCtr.instance.view.ShowTipLabel(\"系統郵件不可刪除，默認保留7天！\");\r\n        }\r\n    }\r\n}"]}